<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<link rel="stylesheet" data-name="vs/editor/editor.main" href="./monaco-editor/min/vs/editor/editor.main.css" />
	<link rel="stylesheet" href="./styles.css" />
	<title>Editor</title>
</head>

<body>
	<div id="messageBox"></div>
	<div id="main">
		<div id="container"></div>
		<div id="middle">
			<div style="width:100%; background-color: #222222; height: 50px; border-right: 1px solid grey;">
				<span style="margin:5px; ">Console</span>
				<br>
				<button onclick="sendRunRequest()">run code</button>
				<button onclick="sendCompileRequest()">compile code</button>
				<button
					onclick="makeNotification('Press Ctrl+S to compile your program\n\nPress Ctrl+Enter to run your program\n\nMake new files by typing the name of the file into the text box and pressing enter.\n\nWhenever you run or compile, your code is saved.\n\nMake sure to save often!', 10000)">help</button>
			</div>
			<div style="width:100%; background-color: #222222; height: 50px;">
				<span style="margin:5px;">Files</span>
				<br>
				<input autocomplete="off" type="text" placeholder="Make new file" id="newFile">
				<button onclick="deleteRequest()">delete current file</button>
			</div>
		</div>
		<div id="bottom">
			<div id="output">
				<div id="console"></div>
			</div>
			<div id="fileSystem">
				<span id="list"></span>
			</div>
		</div>
	</div>
	<script src="./users.js"></script>

	<script>
		let key = document.cookie.split("key=")[1];
		checkLogin(key, "./loginSite");
		var require = { paths: { vs: '../monaco-editor/min/vs' } };
	</script>
	<script src="./monaco-editor/min/vs/loader.js"></script>
	<script src="./monaco-editor/min/vs/editor/editor.main.nls.js"></script>
	<script src="./monaco-editor/min/vs/editor/editor.main.js"></script>
	<script src="./communicate.js"></script>
	<script src="./notifications.js"></script>
	<script>
		const re = new RegExp("^[_A-z0-9]*((-|\s)*[_A-z0-9])*$");
		let keyCounter = 0;
		var editor = monaco.editor.create(document.getElementById('container'), {
			language: 'java',
			theme: 'vs-dark'
		});
		const starter = async () => {
			await getFile("Main");
			readFiles();
		}
		starter();

		document.getElementById("newFile").addEventListener("keyup", async event => {
			if (event.key !== "Enter") return;
			const re = new RegExp("^[_A-z]((-|\s)*[_A-z0-9])*$");
			let name = document.getElementById("newFile").value;
			try {
				document.getElementById("newFile").value = "";
				name = re.exec([name])[0];
				const response = await fetch("./makefile?name=" + name, {
					method: 'POST',
					headers: {
						"Authorization": document.cookie.split("key=")[1]
					},
				});
				readFiles();
			} catch (err) {
				makeNotification("Invalid name for file! (Must be alphanumeric and start with a letter)")
			}
			event.preventDefault();
		});
		document.addEventListener("keydown", function (e) {
			if (e.keyCode === 83 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
				e.preventDefault();
				sendCompileRequest();
			}
			if (e.keyCode === 13 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
				e.preventDefault();
				sendRunRequest();
			}
		}, false);

		document.getElementById("container").addEventListener("keydown", function (e) {
			let code = e.keyCode;
			let char = String.fromCharCode(code);
			if (re.test(char)) {
				keyCounter++;
			}
			if (code === 13 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
				e.preventDefault();
				sendRunRequest();
			}
			if (keyCounter == 50) {
				console.log("Updating hash!");
				updateHash();
				keyCounter = 0;
			}
		}, false);

		(function () {
			// resize the canvas to fill browser window dynamically
			window.addEventListener('resize', resizeEditor, false);

			function resizeEditor() {
				let temp = document.getElementById("container").getBoundingClientRect();
				editor.layout({"height": temp.height-2, "width":temp.width-2});
			}

			resizeEditor();
		})();
	</script>
</body>

</html>